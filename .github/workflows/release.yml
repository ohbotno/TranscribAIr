name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger on version tags like v1.0.0
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write  # Required for creating releases

jobs:
  build-windows:
    name: Build Windows Executable
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for changelog

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'  # Use stable Python version
          cache: 'pip'

      - name: Get version from tag
        id: get_version
        shell: bash
        run: |
          # Extract version from tag (v1.0.0 -> 1.0.0)
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Install FFmpeg
        run: |
          python install_ffmpeg.py --auto
        env:
          PYTHONIOENCODING: 'utf-8'
        continue-on-error: false

      - name: Build executable with PyInstaller
        run: |
          python build.py
        env:
          PYTHONIOENCODING: 'utf-8'

      - name: Verify build
        shell: bash
        run: |
          if [ -f "dist/Transcribair.exe" ]; then
            echo "âœ“ Executable built successfully"
            ls -lh dist/Transcribair.exe
          else
            echo "âœ— Build failed - executable not found"
            exit 1
          fi

      - name: Create portable ZIP
        shell: bash
        run: |
          cd dist
          7z a -tzip ../TranscribAIr-${{ steps.get_version.outputs.version }}-Portable.zip Transcribair.exe
          cd ..
          echo "âœ“ Portable ZIP created"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-executable
          path: |
            dist/Transcribair.exe
            TranscribAIr-${{ steps.get_version.outputs.version }}-Portable.zip
          retention-days: 7

  create-release:
    name: Create GitHub Release
    needs: build-windows
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Creating release for version: $VERSION"

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-executable
          path: ./artifacts

      - name: Extract changelog for this version
        id: changelog
        run: |
          # Extract release notes from CHANGELOG.md for this version
          VERSION=${{ steps.get_version.outputs.version }}

          # Try to extract the section for this version
          if grep -q "## \[$VERSION\]" CHANGELOG.md; then
            awk "/## \[$VERSION\]/,/## \[/" CHANGELOG.md | sed '1d;$d' > release_notes.md
            echo "âœ“ Changelog extracted for version $VERSION"
          else
            echo "No specific changelog found for version $VERSION, using generic notes"
            echo "## What's New" > release_notes.md
            echo "" >> release_notes.md
            echo "See [CHANGELOG.md](CHANGELOG.md) for detailed changes." >> release_notes.md
          fi

          # Add download instructions
          cat >> release_notes.md << 'EOF'

          ## Installation

          ### For End Users (Recommended)
          - Download `TranscribAIr-$VERSION-Portable.zip`
          - Extract and run `Transcribair.exe`
          - No installation required!

          ### For Developers
          - Clone the repository
          - See [README.md](README.md) for development setup instructions

          ## System Requirements
          - Windows 10/11 (64-bit)
          - 4GB RAM minimum (8GB+ recommended)
          - 500MB disk space + Whisper models (75MB-2.9GB)

          EOF

          cat release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: TranscribAIr v${{ steps.get_version.outputs.version }}
          body_path: release_notes.md
          files: |
            ./artifacts/TranscribAIr-${{ steps.get_version.outputs.version }}-Portable.zip
            LICENSE
            README.md
            CHANGELOG.md
          draft: false
          prerelease: false
          generate_release_notes: true  # Auto-generate from commits
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release summary
        run: |
          echo "ðŸŽ‰ Release v${{ steps.get_version.outputs.version }} created successfully!"
          echo "ðŸ“¦ Artifacts uploaded:"
          echo "  - TranscribAIr-${{ steps.get_version.outputs.version }}-Portable.zip"
          echo "  - Source code (automatic)"
          echo ""
          echo "ðŸ”— View release: https://github.com/${{ github.repository }}/releases/tag/v${{ steps.get_version.outputs.version }}"

  # Optional: Build installer with Inno Setup (requires Inno Setup pre-installed or Docker)
  # This job is commented out by default - uncomment if you want automated installer builds
  # build-installer:
  #   name: Build Windows Installer
  #   needs: build-windows
  #   runs-on: windows-latest
  #
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Download executable artifact
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: windows-executable
  #         path: ./dist
  #
  #     - name: Install Inno Setup
  #       run: |
  #         choco install innosetup -y
  #
  #     - name: Build installer
  #       run: |
  #         & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer.iss
  #
  #     - name: Upload installer
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: windows-installer
  #         path: Output/TranscribAIr-*-Setup.exe
